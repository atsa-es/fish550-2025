{"title":"Lab Intro","markdown":{"yaml":{"title":"Lab Intro","subtitle":"Lab 4 Hidden Markov Models","author":"Eric Ward","date":"Due Tues May 9 11:59 PM PDT","output":{"html_document":{"code-folding":true,"toc":true,"toc_float":true}}},"headingText":"Part 1. Hidden Markov Models","headingAttr":{"id":"sec-hmm","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"\n\n```{r hw6p1-setup, echo=FALSE}\nknitr::opts_knit$set(unnamed.chunk.label = \"lab4-\",\n                     message=FALSE,\n                     warning=FALSE)\n```\n\n<br>\n\n\n**Identifying regimes using Hidden Markov Models (HMMs)**\n\nFor the first part of the homework, we'll use data from the Pacific\nDecadal Oscillation (PDO) to ask questions about identifying regimes.\nThis dataset can be accessed via the `rsoi` package. First, let's grab\nthe data. Run the `install.packages()` code if you need the `rsoi`\npackage.\n\n```{r read-data, message=FALSE, warning=FALSE}\nlibrary(dplyr)\nlibrary(rsoi)\n#install.packages(\"rsoi\")\npdo <- rsoi::download_pdo()\n```\n\nWe will look at the winter PDO only. We need to shift the year for\nOct-Dec by 1 since Oct-Feb spans 2 calendar years.\n\n```{r read-data2}\npdo$Year[which(pdo$Month%in%c(\"Oct\",\"Nov\",\"Dec\"))] <- pdo$Year[which(pdo$Month%in%c(\"Oct\",\"Nov\",\"Dec\"))] + 1\npdo <- dplyr::group_by(pdo, Year) %>%\n  dplyr::summarize(winter_pdo = mean(PDO[which(Month %in% c(\"Oct\",\"Nov\",\"Dec\",\"Jan\",\"Feb\"))])) %>% \n  dplyr::select(winter_pdo, Year)\n# The first year will be missing Oct-Dec\npdo <- pdo[-1,]\n```\n\nUse `pdo` for your analyses. You will be modeling `winter_pdo`. Use the\n`hmmTMB` or `depmixS4` packages discussed in the [HMM\nlecture](https://atsa-es.github.io/atsa/Lectures/Week%205/lec_10_hmm.html#1).\n\n1.  Fit a 2-state HMM to the annual indices of winter PDO. Assume\n    Gaussian errors (default). See the lecture on HMMs and/or section 3\n    in the [depmixS4\n    vignette](https://cran.r-project.org/web/packages/depmixS4/vignettes/depmixS4.pdf).\n\n2.  Try fitting the model 10-20 times. Does the likelihood seem\n    reasonably stable? (Note `logLik()` in `depmixS4` gets you the log-likelihood from\n    model fits in R).\n\n3.  What is the transition matrix for the best model? What are the\n    persistence probabilities (e.g. probabilities of staying in the same\n    state from step $t$ to $t+1$)?\n\n4.  Plot the predicted values versus year. See slide 50 of the HMM\n    lecture for an example.\n\n5.  Plot the posterior probability of being in the various states from\n    your best model (e.g. probability of being in state 1 over time)\n\n6.  What is the long-run probability that the PDO is in state 1 versus\n    state 2? You can calculate this from the transition matrix. There is\n    an analytical solution for this (a bit of googling will find it). Or\n    you can run a `for` loop to find it. Let $p_1$ be the probability\n    that PDO is in state 1 and $p_2$ be the probability that PDO is in\n    state 2. Note $p_1 + p_2 = 1$. If $P$ is the transition matrix (in\n    Q3),\n\n$$\\begin{bmatrix}p_1&p_2\\end{bmatrix}_n = \\begin{bmatrix}p_1&p_2\\end{bmatrix}_{n-1} P$$\nNote this is a 1x2 matrix times a 2x2 matrix on the right. Start with\n$p_1=1$ and $p_2=0$, say. Run a `for` loop until\n\n$$\\begin{bmatrix}p_1&p_2\\end{bmatrix}_n \\approx \\begin{bmatrix}p_1&p_2\\end{bmatrix}_{n-1}$$\nThat $\\begin{bmatrix}p_1&p_2\\end{bmatrix}_n$ is the long-run probability\nin each state.\n\n**Some ideas for optional extra analyses**\n\n-   Using slide 15 of the HMM lecture as a template and the matrix in\n    Q3, write out your fitted HMM model as equations\n\n-   Change the model to a 3-state model. Using AIC as a model selection\n    metric, does the 3-state model perform better (lower AIC) compared\n    to the 2-state model? What about a 1-state model?\n\n-   If you include time varying parameters (e.g. year) in the means of\n    each state, or state transition probabilities, does the model do any\n    better?\n\n-   Run diagnostics on the best model. Any problems?\n\n-   Compare the transition matrices for fits with different random\n    starting conditions. Are the transition matrices stable?\n\n# Part 2. Fitting Multivariate HMMs\n\nAs part of the California Current Integrated Ecosystem Report, NOAA\nscientists do annual updates of [stoplight charts for ecosystem\nindicators](https://www.fisheries.noaa.gov/west-coast/science-data/ocean-conditions-indicators-trends).\n\nWe have included the `stoplight.csv` dataset for this week. One of the\ncolumns divides indicators into groups (e.g. Local Physical, Local\nBiological, etc). Please pick a type of indicators, and develop a 2- or\n3-state multivariate HMM. A few tips:\n\n-   Assume all responses are Gaussian.\n\n-   You're welcome to include covariates (year? Climate variables?) --\n    but fitting a simple model without covariates is also totally fine\n\nSummarize the model you've created. Specifically,\n\n-   Does it converge?\n\n-   How many states seem to be most supported?\n\n-   What are the transition probabilities?\n\n-   Anything else interesting that you've discovered?\n","srcMarkdownNoYaml":"\n\n```{r hw6p1-setup, echo=FALSE}\nknitr::opts_knit$set(unnamed.chunk.label = \"lab4-\",\n                     message=FALSE,\n                     warning=FALSE)\n```\n\n<br>\n\n# Part 1. Hidden Markov Models {#sec-hmm}\n\n**Identifying regimes using Hidden Markov Models (HMMs)**\n\nFor the first part of the homework, we'll use data from the Pacific\nDecadal Oscillation (PDO) to ask questions about identifying regimes.\nThis dataset can be accessed via the `rsoi` package. First, let's grab\nthe data. Run the `install.packages()` code if you need the `rsoi`\npackage.\n\n```{r read-data, message=FALSE, warning=FALSE}\nlibrary(dplyr)\nlibrary(rsoi)\n#install.packages(\"rsoi\")\npdo <- rsoi::download_pdo()\n```\n\nWe will look at the winter PDO only. We need to shift the year for\nOct-Dec by 1 since Oct-Feb spans 2 calendar years.\n\n```{r read-data2}\npdo$Year[which(pdo$Month%in%c(\"Oct\",\"Nov\",\"Dec\"))] <- pdo$Year[which(pdo$Month%in%c(\"Oct\",\"Nov\",\"Dec\"))] + 1\npdo <- dplyr::group_by(pdo, Year) %>%\n  dplyr::summarize(winter_pdo = mean(PDO[which(Month %in% c(\"Oct\",\"Nov\",\"Dec\",\"Jan\",\"Feb\"))])) %>% \n  dplyr::select(winter_pdo, Year)\n# The first year will be missing Oct-Dec\npdo <- pdo[-1,]\n```\n\nUse `pdo` for your analyses. You will be modeling `winter_pdo`. Use the\n`hmmTMB` or `depmixS4` packages discussed in the [HMM\nlecture](https://atsa-es.github.io/atsa/Lectures/Week%205/lec_10_hmm.html#1).\n\n1.  Fit a 2-state HMM to the annual indices of winter PDO. Assume\n    Gaussian errors (default). See the lecture on HMMs and/or section 3\n    in the [depmixS4\n    vignette](https://cran.r-project.org/web/packages/depmixS4/vignettes/depmixS4.pdf).\n\n2.  Try fitting the model 10-20 times. Does the likelihood seem\n    reasonably stable? (Note `logLik()` in `depmixS4` gets you the log-likelihood from\n    model fits in R).\n\n3.  What is the transition matrix for the best model? What are the\n    persistence probabilities (e.g. probabilities of staying in the same\n    state from step $t$ to $t+1$)?\n\n4.  Plot the predicted values versus year. See slide 50 of the HMM\n    lecture for an example.\n\n5.  Plot the posterior probability of being in the various states from\n    your best model (e.g. probability of being in state 1 over time)\n\n6.  What is the long-run probability that the PDO is in state 1 versus\n    state 2? You can calculate this from the transition matrix. There is\n    an analytical solution for this (a bit of googling will find it). Or\n    you can run a `for` loop to find it. Let $p_1$ be the probability\n    that PDO is in state 1 and $p_2$ be the probability that PDO is in\n    state 2. Note $p_1 + p_2 = 1$. If $P$ is the transition matrix (in\n    Q3),\n\n$$\\begin{bmatrix}p_1&p_2\\end{bmatrix}_n = \\begin{bmatrix}p_1&p_2\\end{bmatrix}_{n-1} P$$\nNote this is a 1x2 matrix times a 2x2 matrix on the right. Start with\n$p_1=1$ and $p_2=0$, say. Run a `for` loop until\n\n$$\\begin{bmatrix}p_1&p_2\\end{bmatrix}_n \\approx \\begin{bmatrix}p_1&p_2\\end{bmatrix}_{n-1}$$\nThat $\\begin{bmatrix}p_1&p_2\\end{bmatrix}_n$ is the long-run probability\nin each state.\n\n**Some ideas for optional extra analyses**\n\n-   Using slide 15 of the HMM lecture as a template and the matrix in\n    Q3, write out your fitted HMM model as equations\n\n-   Change the model to a 3-state model. Using AIC as a model selection\n    metric, does the 3-state model perform better (lower AIC) compared\n    to the 2-state model? What about a 1-state model?\n\n-   If you include time varying parameters (e.g. year) in the means of\n    each state, or state transition probabilities, does the model do any\n    better?\n\n-   Run diagnostics on the best model. Any problems?\n\n-   Compare the transition matrices for fits with different random\n    starting conditions. Are the transition matrices stable?\n\n# Part 2. Fitting Multivariate HMMs\n\nAs part of the California Current Integrated Ecosystem Report, NOAA\nscientists do annual updates of [stoplight charts for ecosystem\nindicators](https://www.fisheries.noaa.gov/west-coast/science-data/ocean-conditions-indicators-trends).\n\nWe have included the `stoplight.csv` dataset for this week. One of the\ncolumns divides indicators into groups (e.g. Local Physical, Local\nBiological, etc). Please pick a type of indicators, and develop a 2- or\n3-state multivariate HMM. A few tips:\n\n-   Assume all responses are Gaussian.\n\n-   You're welcome to include covariates (year? Climate variables?) --\n    but fitting a simple model without covariates is also totally fine\n\nSummarize the model you've created. Specifically,\n\n-   Does it converge?\n\n-   How many states seem to be most supported?\n\n-   What are the transition probabilities?\n\n-   Anything else interesting that you've discovered?\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":{"html_document":{"code-folding":true,"toc":true,"toc_float":true}},"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"code-overflow":"wrap","engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"output-file":"Lab-4-HMM.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.39","theme":"cosmo","number-depth":0,"title":"Lab Intro","subtitle":"Lab 4 Hidden Markov Models","author":"Eric Ward","date":"Due Tues May 9 11:59 PM PDT"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}