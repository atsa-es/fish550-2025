{
  "hash": "69b65a30b4617227b0c58d540c1a0c22",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Lab Intro\nsubtitle: Lab 1 Forecasting with ARIMA models\nauthor: E Holmes\ndate: March 22, 2023\noutput: \n  html_document:\n    code-folding: true\n    toc: true\n    toc_float: true\n---\n\n\n\n\n\n\nFor this lab you will use the material you have learned in the first 3 lectures to explore features of time series of salmon in the North Pacific (Alaska and E Asia). Then you will use ARIMA models to create forecasts and ask a research question with those forecasts.\n\n## Teams\n\n1. Bristol Bay Data: Nick Chambers (SAFS), Liz Elmstrom (SAFS), Maria Kuruvilla (QERM)\n2. Bristol Bay Data: Eric French (Civil), Dylan Hubl (ESRM), Miranda Mudge (Molecular & Cell Bio)\n3. Ruggerone & Irvine Data: Zoe Rand (QERM), Madison Shipley (SAFS), Emma Timmins-Schiffman (Genome Sci)\n4. Ruggerone & Irvine Data: Terrance Wang (SAFS), Josh Zahner (SAFS), Karl Veggerby (SAFS)\n\n## References\n\nHolmes, E. E. (2020) Fisheries Catch Forecasting <https://fish-forecast.github.io/Fish-Forecast-Bookdown>\n\nHyndman, R.J., & Athanasopoulos, G. (2018) Forecasting: principles and practice, 2nd edition, OTexts: Melbourne, Australia. <https://otexts.com/fpp2/>.\n\nPlus the lecture material on the ATSA website.\n\n## Type of questions you might ask\n\n\"Compare the accuracy of forecasts using best fit ARIMA models for pink salmon using the different regions in the Ruggerone & Irvine data. Is forecast accuracy is different for different regions?\"\n\n\"Compare the accuracy of total abundance forecasts using ARIMA models for Bristol Bay sockeye rivers and compare to the AKFW and UW FRI forecasts.\"\n\n\"Compare the accuracy of age-group forecasts using ARIMA models for Bristol Bay sockeye and compare to the AKFW and UW FRI forecasts.\"\n\n\"Use the Ruggerone & Irvine data and ARIMA models to study the autoregressive structure of pink, chum and sockeye. Are there differences by region (AK verus E Asia)?\"\n\n\"Compare the forecasts of total North Pacific pink and chum using 5, 10, 15, and 20 years of training data. Does forecast accuracy increase with more training data?\"\n\n\"Create 1-year forecasts of total North Pacific pink salmon using 20 years of training data for all of the Ruggerone and Irvine data. Is forecast error correlated with the PDO?\"\n\n## Bristol Bay Sockeye data\n\nThe `bristol_bay_data_plus_covariates.rds` file has Bristol Bay sockeye abundance for 9 rivers for 4 age-groups. The data are from Ovando et al 2021 Improving forecasts of sockeye salmon (Oncorhynchus nerka) with parametric and nonparametric models DOI: 10.1139/cjfas-2021-0287. You'll find a copy in the lab folder. The data file also has the covariates for year that the smolts enter the ocean as used in Ovando et al. \n\nLoad the data.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbb_data <- readRDS(here::here(\"Lab-1\", \"Data_Images\", \"bristol_bay_data_plus_covariates.rds\"))\n```\n:::\n\n\n\n\nThe data you will most likely want are\n\n* `ret_yr` The year the spawners return to the spawning grounds\n* `ret` The returns (number of fish in 1000s)\n* `system` The river name\n* `age_group` The age_group\n* `forecast.adfw` The forecast from AK Fish and Wildlife\n* `forecast.fri` The forecast from UW Fisheries Research Institute\n* `env_*` are some covariates at the year the age group entered the ocean\n\nIn the data file, the age group designation is \"a.b\" where \"a\" is number of years in freshwater and \"b\" is number of years in the ocean. The age of the spawners in then `a+b`.  \n\n![](Data_Images/BB_sockeye_rivers_inset.png){width=\"50%\"}\n\nThe data\n\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\ncolnames:  brood_yr ret_yr system fw_age o_age age_group ret forecast.adfw forecast.fri env_pdo env_sst env_slp env_upstr \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nsystem (river):  Igushik Wood Nushagak Kvichak Naknek Egegik Ugashik \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nage groups:  \n```\n\n\n:::\n:::\n\n\n\n\nSome plots of the Bristol Bay data. Hmm there is a NA that was replaced with 0 it looks like.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbb_data %>% \n  filter(system==\"Kvichak\") %>% \n  ggplot(aes(x=ret_yr, y=log(ret))) + \n    geom_line() + \n    ggtitle(\"log abundance by age group\") +\n    facet_wrap(~age_group)\n```\n\n::: {.cell-output-display}\n![plotted by age group](Lab1-ARIMA_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbb_data %>% \n  group_by(system, ret_yr) %>%\n  summarize(total = sum(ret, na.rm=TRUE)) %>%\n  ggplot(aes(x=ret_yr, y=log(total))) + \n    geom_line() + \n    ggtitle(\"log abundance by river\") +\n    facet_wrap(~system)\n```\n\n::: {.cell-output-display}\n![total across all 4 ages](Lab1-ARIMA_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n### Some subsets of the data\n\nHere are some subsets of the data that you might want to use.\n\nLog total by age group\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubdata <- bb_data %>% \n  group_by(age_group, ret_yr) %>%\n  summarize(lntotal = log(sum(ret, na.rm=TRUE)))\nhead(subdata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n# Groups:   age_group [1]\n  age_group ret_yr lntotal\n  <chr>      <dbl>   <dbl>\n1 1.2         1963    7.49\n2 1.2         1964    8.50\n3 1.2         1965    7.22\n4 1.2         1966    7.18\n5 1.2         1967    6.88\n6 1.2         1968    8.11\n```\n\n\n:::\n:::\n\n\n\n\nLog total by river\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubdata <- bb_data %>% \n  group_by(system, ret_yr) %>%\n  summarize(lntotal = log(sum(ret, na.rm=TRUE)))\nhead(subdata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n# Groups:   system [1]\n  system ret_yr lntotal\n  <chr>   <dbl>   <dbl>\n1 Egegik   1963    7.54\n2 Egegik   1964    7.55\n3 Egegik   1965    8.55\n4 Egegik   1966    7.95\n5 Egegik   1967    7.41\n6 Egegik   1968    6.88\n```\n\n\n:::\n:::\n\n\n\n\nCompare fish that spend 2 years in ocean versus those that spend 3 years.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubdata <- bb_data %>% \n  mutate(\n    ocean_years = case_match(\n      age_group, \n      c(\"2.3\", \"1.3\") ~ \"3-yr-ocean\",\n      c(\"1.2\", \"2.2\") ~ \"2-yr-ocean\",\n      .default = age_group\n    )) %>%\n  group_by(system, ocean_years, ret_yr) %>%\n  summarize(lntotal = log(sum(ret, na.rm=TRUE)))\nhead(subdata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 4\n# Groups:   system, ocean_years [1]\n  system ocean_years ret_yr lntotal\n  <chr>  <chr>        <dbl>   <dbl>\n1 Egegik 2-yr-ocean    1963    7.02\n2 Egegik 2-yr-ocean    1964    7.29\n3 Egegik 2-yr-ocean    1965    8.34\n4 Egegik 2-yr-ocean    1966    5.96\n5 Egegik 2-yr-ocean    1967    6.58\n6 Egegik 2-yr-ocean    1968    6.35\n```\n\n\n:::\n:::\n\n\n\n\nGet one time series and split into train and test. Each with 10 years.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- bb_data %>%\n  filter(system == \"Kvichak\", age_group == \"1.3\") %>%\n  mutate(lnreturns = log(ret),\n         year = ret_yr) %>%\n  select(year, lnreturns)\ndatts <- ts(dat$lnreturns, start=dat$year[1])\ntrain <- window(datts, dat$year[1], dat$year[1]+9)\ntest <- window(datts, dat$year[1]+10, dat$year[1]+10+9)\n```\n:::\n\n\n\n\n## Ruggerone & Irvine: Salmon in the North Pacific\n\nThe data set `Data_Images/ruggerone_data.rds` has total abundance of natural spawners (not hatchery) from 15 regions in the N Pacific. These are data provided with Ruggerone, G. and Irvine, J. 2018. Numbers and biomass of natural- and hatchery-origin Pink, Chum, and Sockeye Salmon in the North Pacific Ocean, 1925-2015. Marine and Coastal Fisheries: Dynamics, Management, and Ecosystem Science 10. DOI: [10.1002/mcf2.10023](https://afspubs.onlinelibrary.wiley.com/doi/10.1002/mcf2.10023). Open Access.\n\nLoad the data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nruggerone_data <- readRDS(here::here(\"Lab-1\", \"Data_Images\", \"ruggerone_data.rds\"))\n```\n:::\n\n\n\n\n![Figure 1. The approximate geographic locations of regional stock groups. Region 1, Washington State, including the Columbia River. Region 2, Southern British Columbia (BC) south of the central coast of British Columbia (\\~51°N). . Region 3, Northern BC including central and northern British Columbia. Region 4, Southeast Alaska (AK) including the Yakutat coast. The Central Alaska region extends from the Bering River (\\~60°N), near Prince William Sound in Region 5, westward to Unimak Island (\\~166°W), thereby including Regions 5 through 8. Western Alaska includes Regions 9 through 12, i.e., all North American drainages flowing into the Bering Sea from Unimak Island to Kotzebue. Data for eastern and western Kamchatka (Regions 14 and 15) are separated from data for the Russian mainland and islands (called \"Mainland & Islands\" here, which includes the Okhotsk coast, Amur River, Primorye, Sakhalin and Kurile Islands, and relatively small runs to the Anadyr). Region 20, Japan, includes the islands of Hokkaido and Honshu. South Korea (Region 21) not shown.](Data_Images/NPacific_map.jpg){width=\"50%\"}\n\n| region in data file    | desciption                  | regions in map    |\n|------------------------|-----------------------------|-------------------|\n| japan                  |  Japan & South Korea        | 20 and 21         |\n| m_i                    | Russian Mainland & Islands  | 13, 16, 17 18, 19 |\n| w_kam                  | Western Kamchatka           | 15                |\n| e_kam                  | Eastern Kamchatka           | 14                |\n| wak                    | Western Alaska              | 9, 10, 11, 12     |\n| s_pen                  | Southern Alaska Peninsula   | 8                 |\n| kod                    | Kodiak                      | 7                 |\n| ci                     | Cook Inlet                  | 6                 |\n| pws                    | Prince William Sound        | 5                 |\n| seak                   | Southeast Alaska            | 4                 |\n| nbc                    | Northern British Columbia   | 3                 |\n| sbc                    | Southern British Columbia   | 2                 |\n| wa                     | Washington State            | 1                 |\n| wc                     | West Coast USA              | mislabeled on map |\n| cak (not in data file) | Central Alaska              | 5, 6, 7, 8        |\n\n### Ruggerone and Irvine data\n\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\ncolnames:  year region returns species \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nspecies:  pink chum sockeye \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nregions:  ci e_kam japan kod korea m_i nbc pws sbc seak s_pen wa wak w_kam wc \n```\n\n\n:::\n:::\n\n\n\n\n### Some plots of the Ruggerone and Irvine data.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nruggerone_data %>% \n  filter(species==\"pink\") %>% \n  ggplot(aes(x=year, y=log(returns))) + \n    geom_line() + \n    ggtitle(\"pink salmon log abundance\") +\n    facet_wrap(~region)\n```\n\n::: {.cell-output-display}\n![pink salmon by regions](Lab1-ARIMA_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nruggerone_data %>% \n  group_by(species, year) %>%\n  summarize(total = sum(returns, na.rm=TRUE)) %>%\n  ggplot(aes(x=year, y=log(total))) + \n    geom_line() + \n    ggtitle(\"log abundance by species\") +\n    facet_wrap(~species)\n```\n\n::: {.cell-output-display}\n![total by species](Lab1-ARIMA_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n### Some subsets of the data\n\nHere are some subsets of the data that you might want to use.\n\nLog total North Pacific pink, chum, sockeye\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubdata <- ruggerone_data %>% \n  group_by(species, year) %>%\n  summarize(lntotal = log(sum(returns, na.rm=TRUE)))\nhead(subdata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n# Groups:   species [1]\n  species  year lntotal\n  <chr>   <dbl>   <dbl>\n1 chum     1952    3.91\n2 chum     1953    3.88\n3 chum     1954    4.20\n4 chum     1955    4.28\n5 chum     1956    4.38\n6 chum     1957    4.08\n```\n\n\n:::\n:::\n\n\n\n\nLog North Pacific pink\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubdata <- ruggerone_data %>% \n  filter(species == \"pink\") %>%\n mutate(lnreturns = log(returns))\nhead(subdata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n   year region returns species lnreturns\n  <dbl> <chr>    <dbl> <chr>       <dbl>\n1  1952 ci       4.36  pink        1.47 \n2  1953 ci       1.30  pink        0.264\n3  1954 ci       4.67  pink        1.54 \n4  1955 ci       2.67  pink        0.981\n5  1956 ci       3.57  pink        1.27 \n6  1957 ci       0.804 pink       -0.218\n```\n\n\n:::\n:::\n\n\n\n\nTotal in some bigger areas\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubdata <- ruggerone_data %>% \n  mutate(\n    area = case_match(\n      region, \n      c(\"japan\", \"korea\", \"m_i\", \"e_kam\", \"w_kam\") ~ \"East_Asia\",\n      c(\"wak\", \"s_pen\", \"kod\", \"ci\", \"pws\", \"seak\") ~ \"Alaska\",\n      c(\"nbc\", \"sbc\", \"wa\", \"wc\") ~ \"WC\",\n      .default = region\n    )) %>%\n  group_by(area, species, year) %>%\n  summarize(lntotal = log(sum(returns, na.rm=TRUE)))\nhead(subdata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 4\n# Groups:   area, species [1]\n  area   species  year lntotal\n  <chr>  <chr>   <dbl>   <dbl>\n1 Alaska chum     1952    2.83\n2 Alaska chum     1953    2.77\n3 Alaska chum     1954    2.92\n4 Alaska chum     1955    2.47\n5 Alaska chum     1956    2.81\n6 Alaska chum     1957    2.89\n```\n\n\n:::\n:::\n\n\n\n\n## Example analysis\n\nGet one time series out of `ruggerone_data`\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- ruggerone_data %>%\n  filter(region == \"wak\", species == \"pink\") %>%\n  mutate(lnreturns = log(returns)) %>%\n  select(year, lnreturns)\nhead(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 2\n   year lnreturns\n  <dbl>     <dbl>\n1  1952      1.40\n2  1953     -1.24\n3  1954      1.40\n4  1955     -1.24\n5  1956      1.40\n6  1957     -1.24\n```\n\n\n:::\n:::\n\n\n\n\nMake a time series object and divide into train and test data.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndatts <- ts(dat$lnreturns, start=dat$year[1])\ntrain <- window(datts, 1952, 1971)\ntest <- window(datts, 1972, 2001)\n```\n:::\n\n\n\n\n\nFit a model with `auto.arima()` in the forecast package.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(forecast)\nmod <- auto.arima(train)\nmod\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSeries: train \nARIMA(1,0,0) with zero mean \n\nCoefficients:\n          ar1\n      -0.9293\ns.e.   0.0725\n\nsigma^2 = 0.3815:  log likelihood = -19.22\nAIC=42.45   AICc=43.15   BIC=44.44\n```\n\n\n:::\n:::\n\n\n\n\nPlot a 30-year forecast against the test data.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(zoo)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'zoo'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    as.Date, as.Date.numeric\n```\n\n\n:::\n\n```{.r .cell-code}\nfr <- forecast(mod, h=30)\nautoplot(fr) + geom_point(aes(x=x, y=y), data=fortify(test))\n```\n\n::: {.cell-output-display}\n![](Lab1-ARIMA_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "Lab1-ARIMA_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}